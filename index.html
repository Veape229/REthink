<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°‘å„¿ç¼–ç¨‹æ•™å­¦åæ€ç”Ÿæˆå™¨ V5.1 (ç¼–è¾‘å¢å¼ºç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS with Style Support (xlsx-js-style) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 50;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; color: #3b82f6; font-weight: bold;
        }
        .ai-modal {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- LeanCloud åˆå§‹åŒ– ---
        const APP_ID = 'Sx1nSaU2TUCAbzB29iLyrRai-gzGzoHsz';
        const APP_KEY = 'dn5qcsJvY3BetbUMnEgAJNtn';
        const SERVER_URL = 'https://sx1nsau2.lc-cn-n1-shared.com';

        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURL: SERVER_URL
        });

        // --- åˆå§‹æ•°æ® ---
        const INITIAL_COURSES_DATA = [
            { name: 'é£æœºå¤§æˆ˜', age: '8', r1: 'æ•™å­¦ç›®æ ‡è®¾ç½®åˆç†ï¼Œæœ¬èŠ‚è¯¾é‡ç‚¹è®²è§£åæ ‡ç³»ä¸éšæœºæ•°ã€‚éš¾ç‚¹åœ¨äºè®©å­¦ç”Ÿç†è§£åæ ‡æ•°å­—æ”¹å˜ï¼Œè§’è‰²ç›¸åº”ç§»åŠ¨', r2: 'åˆç†ï¼Œé€šè¿‡åˆ†ææ•Œæœºâ€œç¢°åˆ°è‹±é›„å¥½ç¨‹åºåœæ­¢â€çš„é€»è¾‘ï¼Œé”»ç‚¼äº†å­¦ç”Ÿå¯¹æ¡ä»¶åˆ¤æ–­æŒ‡ä»¤çš„è¿ç”¨èƒ½åŠ›ã€‚', r3: 'æµç¨‹éœ€è¦è°ƒæ•´ï¼Œåœ¨è®²è§£åæ ‡ï¼ˆX,Yè½´æ­£è´Ÿå€¼ï¼‰æ—¶èŠ±è´¹è¾ƒå¤šæ—¶é—´ï¼Œä¸‹æ¬¡å¯ä»¥ç”¨èˆå°èƒŒæ™¯å›¾è¾…åŠ©å­¦ç”Ÿè¿›è¡Œç†è§£ã€‚', r4: 'ç¼–ç¨‹ç¯èŠ‚è¿›è¡Œäº†ç®€åŒ–ï¼Œæœ¬ç­å­¦ç”Ÿå¯¹å¤šä¸ªè§’è‰²çš„åæ ‡æ§åˆ¶å®¹æ˜“æ··æ·†ï¼Œåªä¿ç•™äº†ä¸€ä¸ªæ•Œæœºè§’è‰²ï¼Œé‡ç‚¹ä¿è¯åŸºç¡€é€»è¾‘çš„é€šé¡ºã€‚' }
        ];

        const INITIAL_CLASSES_DATA = [
            { name: 'Scratch14ç­' }, { name: 'Scratch15ç­' }, { name: 'Scratch16ç­' }, 
            { name: 'Scratch17ç­' }, { name: 'Scratch18ç­' }, { name: 'å•ç‰‡æœº4ç­' }
        ];

        // --- å›¾æ ‡ç»„ä»¶ ---
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const IconTrash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const IconBookOpen = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>;
        const IconEdit3 = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>;
        const IconFileText = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const IconSave = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const IconUser = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const IconCloud = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>;
        const IconMagic = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>;
        const IconCopy = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const IconCalendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const IconUpdate = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>;

        // --- AI åŠ©æ‰‹æ¨¡æ€æ¡† ---
        const AIModal = ({ isOpen, onClose, onFillData, courseName, age }) => {
            const [step, setStep] = useState(1);
            const [planText, setPlanText] = useState('');
            const [aiResult, setAiResult] = useState('');
            const [generatedPrompt, setGeneratedPrompt] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);

            if (!isOpen) return null;

            const handleGeneratePrompt = () => {
                if (!planText.trim()) {
                    alert("è¯·å…ˆç²˜è´´æ•™æ¡ˆå†…å®¹ï¼");
                    return;
                }
                const prompt = `æˆ‘æ˜¯ä¸€åå°‘å„¿ç¼–ç¨‹è€å¸ˆï¼Œè¯·æ ¹æ®ä»¥ä¸‹æ•™æ¡ˆå†…å®¹ï¼Œä¸ºã€Š${courseName || 'å°‘å„¿ç¼–ç¨‹'}ã€‹è¯¾ç¨‹ï¼ˆ${age || '8'}å²ï¼‰æ’°å†™æ•™å­¦åæ€ã€‚
                
è¯·ä¸¥æ ¼ä¸”**åª**è¿”å›ä»¥ä¸‹JSONæ ¼å¼ï¼ˆä¸è¦åŒ…å«Markdownä»£ç å—æ ‡è®°ï¼Œä¸è¦åŒ…å«å…¶ä»–è§£é‡Šæ€§æ–‡å­—ï¼‰ï¼š
{"r1": "é’ˆå¯¹æ•™å­¦ç›®æ ‡çš„ç®€çŸ­åæ€...", "r2": "é’ˆå¯¹æ€ç»´èƒ½åŠ›è®­ç»ƒçš„ç®€çŸ­åæ€...", "r3": "é’ˆå¯¹è¯¾ç¨‹æµç¨‹/ç¯èŠ‚çš„åæ€...", "r4": "é’ˆå¯¹ç¼–ç¨‹/æ­å»ºç¯èŠ‚çš„åæ€..."}

æ¯ä¸€æ¡åæ€æ§åˆ¶åœ¨50-80å­—ä¹‹é—´ï¼Œè¯­è¨€ä¸“ä¸šã€å®¢è§‚ã€‚

æ•™æ¡ˆå†…å®¹ï¼š
${planText}`;
                
                setGeneratedPrompt(prompt);
                setStep(2);
            };

            const handleCopyPrompt = () => {
                navigator.clipboard.writeText(generatedPrompt);
                setCopySuccess(true);
                setTimeout(() => setCopySuccess(false), 2000);
            };

            const handleParseResult = () => {
                try {
                    let cleanJson = aiResult.trim();
                    if (cleanJson.startsWith('```json')) {
                        cleanJson = cleanJson.replace(/^```json/, '').replace(/```$/, '');
                    } else if (cleanJson.startsWith('```')) {
                        cleanJson = cleanJson.replace(/^```/, '').replace(/```$/, '');
                    }
                    const data = JSON.parse(cleanJson);
                    if (data.r1 || data.r2 || data.r3 || data.r4) {
                        onFillData(data);
                        onClose();
                        setStep(1); setPlanText(''); setAiResult(''); setGeneratedPrompt('');
                    } else {
                        alert("è§£æå¤±è´¥ï¼šAIè¿”å›çš„æ ¼å¼ä¼¼ä¹ä¸å¯¹ï¼Œè¯·ç¡®ä¿å®ƒè¿”å›äº†JSONæ ¼å¼ã€‚");
                    }
                } catch (e) {
                    alert("è§£æé”™è¯¯ï¼šè¯·ç¡®è®¤ä½ ç²˜è´´çš„æ˜¯AIç”Ÿæˆçš„JSONä»£ç ã€‚\né”™è¯¯ä¿¡æ¯: " + e.message);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto ai-modal">
                        <div className="bg-gradient-to-r from-purple-600 to-blue-600 p-4 rounded-t-xl flex justify-between items-center text-white">
                            <h3 className="text-xl font-bold flex items-center"><IconMagic /> <span className="ml-2">AI æ™ºèƒ½åæ€åŠ©æ‰‹</span></h3>
                            <button onClick={onClose} className="hover:bg-white hover:bg-opacity-20 rounded-full p-1">&times;</button>
                        </div>
                        <div className="p-6">
                            {step === 1 ? (
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">ç¬¬ä¸€æ­¥ï¼šè¾“å…¥æ•™æ¡ˆ/è¯¾ç¨‹é‡ç‚¹</h4>
                                    <p className="text-sm text-gray-500 mb-4">æŠŠä½ è¿™èŠ‚è¯¾çš„æ•™æ¡ˆã€çŸ¥è¯†ç‚¹æˆ–è€…è¯¾å ‚æƒ…å†µç®€å•ç²˜è´´åœ¨è¿™é‡Œã€‚</p>
                                    <textarea className="w-full h-40 border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder="ä¾‹å¦‚ï¼šæœ¬èŠ‚è¯¾ä¸»è¦æ•™äº†å¾ªç¯åµŒå¥—..." value={planText} onChange={(e) => setPlanText(e.target.value)}></textarea>
                                    <div className="mt-4 flex justify-end">
                                        <button onClick={handleGeneratePrompt} className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg shadow font-medium flex items-center">ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆ AI æŒ‡ä»¤ <span className="ml-2">â†’</span></button>
                                    </div>
                                </div>
                            ) : (
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">ç¬¬äºŒæ­¥ï¼šå¤åˆ¶æŒ‡ä»¤å‘ç»™ AIï¼Œå¹¶å›å¡«ç»“æœ</h4>
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 relative group">
                                        <p className="text-xs text-gray-500 uppercase font-bold mb-1">ç»™ AI çš„æŒ‡ä»¤ (Prompt)</p>
                                        <div className="text-xs text-gray-600 max-h-24 overflow-y-auto whitespace-pre-wrap font-mono">{generatedPrompt}</div>
                                        <button onClick={handleCopyPrompt} className={`absolute top-2 right-2 flex items-center px-3 py-1 rounded text-sm transition ${copySuccess ? 'bg-green-100 text-green-700' : 'bg-white border hover:bg-gray-100 text-gray-700 shadow-sm'}`}>{copySuccess ? <><IconCheck /><span className="ml-1">å·²å¤åˆ¶</span></> : <><IconCopy /><span className="ml-1">å¤åˆ¶</span></>}</button>
                                    </div>
                                    <div className="flex flex-col md:flex-row gap-6 items-start">
                                        <div className="flex-1 w-full">
                                            <label className="block text-sm font-bold text-gray-700 mb-2">å°† AI å›å¤ç²˜è´´åˆ°è¿™é‡Œï¼š</label>
                                            <textarea className="w-full h-32 border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none font-mono" placeholder='{"r1": "...", "r2": "..."}' value={aiResult} onChange={(e) => setAiResult(e.target.value)}></textarea>
                                        </div>
                                    </div>
                                    <div className="mt-6 flex justify-between items-center">
                                        <button onClick={() => setStep(1)} className="text-gray-500 hover:text-gray-700 text-sm underline">â† è¿”å›ä¿®æ”¹æ•™æ¡ˆ</button>
                                        <button onClick={handleParseResult} disabled={!aiResult} className={`px-6 py-2 rounded-lg shadow font-bold flex items-center transition ${!aiResult ? 'bg-gray-300 cursor-not-allowed text-gray-500' : 'bg-green-600 hover:bg-green-700 text-white'}`}><IconMagic /> <span className="ml-2">æ™ºèƒ½è§£æå¹¶å¡«è¡¨</span></button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ä¸»åº”ç”¨ç»„ä»¶ ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('record');
            const [isLoading, setIsLoading] = useState(false);
            const [isAIModalOpen, setIsAIModalOpen] = useState(false);
            
            // æ•°æ® State
            const [courses, setCourses] = useState([]);
            const [records, setRecords] = useState([]);
            const [savedClasses, setSavedClasses] = useState([]);
            
            // ç¼–è¾‘æ¨¡å¼ State
            const [editingId, setEditingId] = useState(null); // å¦‚æœæœ‰å€¼ï¼Œè¯´æ˜æ­£åœ¨ç¼–è¾‘æ¨¡å¼
            
            const [newClassInput, setNewClassInput] = useState('');
            const [settings, setSettings] = useState({
                title: 'ä¹äº«æœªæ¥ 12æœˆ æœˆåº¦æ•™å­¦åæ€è¡¨â€”â€”æäº¤äººï¼šéŸ¦çƒ¨',
                defaultClass: 'Scratch16ç­',
                defaultAge: '8'
            });

            const [currentRecord, setCurrentRecord] = useState({
                date: new Date().toISOString().split('T')[0],
                className: '',
                courseId: '',
                courseName: '', 
                age: '',
                r1: '',
                r2: '',
                r3: '',
                r4: ''
            });

            // --- æ•°æ®åŠ è½½é€»è¾‘ ---
            useEffect(() => {
                const initData = async () => {
                    setIsLoading(true);
                    try {
                        const courseQuery = new AV.Query('CourseTemplate');
                        const courseResults = await courseQuery.limit(100).find();
                        if (courseResults.length === 0) {
                            const initCourses = INITIAL_COURSES_DATA.map(c => {
                                const obj = new AV.Object('CourseTemplate');
                                obj.set('name', c.name); obj.set('age', c.age);
                                obj.set('r1', c.r1); obj.set('r2', c.r2); obj.set('r3', c.r3); obj.set('r4', c.r4);
                                return obj;
                            });
                            await AV.Object.saveAll(initCourses);
                            const newResults = await courseQuery.find();
                            setCourses(newResults.map(r => ({ ...r.attributes, id: r.id })));
                        } else {
                            setCourses(courseResults.map(r => ({ ...r.attributes, id: r.id })));
                        }

                        const classQuery = new AV.Query('ClassPreset');
                        const classResults = await classQuery.limit(100).find();
                        if (classResults.length === 0) {
                            const initClasses = INITIAL_CLASSES_DATA.map(c => {
                                const obj = new AV.Object('ClassPreset');
                                obj.set('name', c.name);
                                return obj;
                            });
                            await AV.Object.saveAll(initClasses);
                            const newClasses = await classQuery.find();
                            setSavedClasses(newClasses.map(r => ({ name: r.get('name'), id: r.id })));
                        } else {
                            setSavedClasses(classResults.map(r => ({ name: r.get('name'), id: r.id })));
                        }

                        const recordQuery = new AV.Query('TeachingRecord');
                        recordQuery.descending('createdAt'); 
                        const recordResults = await recordQuery.limit(500).find();
                        setRecords(recordResults.map(r => ({ ...r.attributes, id: r.id })));

                    } catch (error) {
                        console.error("LeanCloud Init Error:", error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                initData();
            }, []);

            // --- Handlers ---
            const handleTemplateSelect = (e) => {
                const courseId = e.target.value;
                if (!courseId) return; 
                const selectedCourse = courses.find(c => c.id === courseId);
                if (selectedCourse) {
                    setCurrentRecord(prev => ({
                        ...prev,
                        courseId: selectedCourse.id,
                        courseName: selectedCourse.name,
                        age: selectedCourse.age,
                        r1: selectedCourse.r1,
                        r2: selectedCourse.r2,
                        r3: selectedCourse.r3,
                        r4: selectedCourse.r4
                    }));
                }
            };
            
            const handleClassSelect = (e) => {
                const cls = e.target.value;
                if(cls) {
                    setCurrentRecord(prev => ({...prev, className: cls}));
                }
            };

            const handleAIFillData = (data) => {
                setCurrentRecord(prev => ({
                    ...prev,
                    r1: data.r1 || prev.r1,
                    r2: data.r2 || prev.r2,
                    r3: data.r3 || prev.r3,
                    r4: data.r4 || prev.r4
                }));
            };

            // æ–°å¢/æ›´æ–°è®°å½•é€»è¾‘
            const handleSaveRecord = async () => {
                if (!currentRecord.courseName || !currentRecord.className) {
                    alert("è¯·è‡³å°‘å¡«å†™ã€ç­çº§åç§°ã€‘å’Œã€è¯¾ç¨‹åç§°ã€‘ï¼\nåæ€å†…å®¹å¯ä»¥å…ˆç•™ç©ºï¼Œç¨åå†è¡¥ã€‚");
                    return;
                }
                setIsLoading(true);
                try {
                    let record;
                    if (editingId) {
                        // æ›´æ–°æ¨¡å¼
                        record = AV.Object.createWithoutData('TeachingRecord', editingId);
                    } else {
                        // æ–°å¢æ¨¡å¼
                        const Record = AV.Object.extend('TeachingRecord');
                        record = new Record();
                    }
                    
                    record.set('date', currentRecord.date);
                    record.set('className', currentRecord.className);
                    record.set('courseName', currentRecord.courseName);
                    record.set('courseId', currentRecord.courseId);
                    record.set('age', currentRecord.age);
                    record.set('r1', currentRecord.r1 || ''); // å…è®¸ä¸ºç©º
                    record.set('r2', currentRecord.r2 || '');
                    record.set('r3', currentRecord.r3 || '');
                    record.set('r4', currentRecord.r4 || '');
                    
                    const saved = await record.save();
                    
                    if (editingId) {
                        // æ›´æ–°æœ¬åœ°åˆ—è¡¨ä¸­çš„é‚£ä¸€æ¡
                        setRecords(records.map(r => r.id === editingId ? { ...saved.attributes, id: saved.id } : r));
                        alert("è®°å½•å·²æ›´æ–°ï¼");
                    } else {
                        // æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨å¤´éƒ¨
                        setRecords([{ ...saved.attributes, id: saved.id }, ...records]);
                        alert("ä¿å­˜æˆåŠŸï¼");
                    }
                    
                    // é‡ç½®
                    setEditingId(null);
                    setCurrentRecord(prev => ({
                        ...prev,
                        courseId: '',
                        courseName: '',
                        r1: '', r2: '', r3: '', r4: ''
                    }));
                } catch (error) {
                    alert("ä¿å­˜å¤±è´¥: " + error.message);
                } finally {
                    setIsLoading(false);
                }
            };
            
            // è¿›å…¥ç¼–è¾‘æ¨¡å¼
            const handleEditRecord = (record) => {
                setCurrentRecord({
                    date: record.date,
                    className: record.className,
                    courseName: record.courseName,
                    courseId: record.courseId || '',
                    age: record.age,
                    r1: record.r1 || '',
                    r2: record.r2 || '',
                    r3: record.r3 || '',
                    r4: record.r4 || ''
                });
                setEditingId(record.id);
                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // å–æ¶ˆç¼–è¾‘
            const handleCancelEdit = () => {
                if (confirm("ç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚")) {
                    setEditingId(null);
                    setCurrentRecord(prev => ({
                        ...prev,
                        courseId: '',
                        courseName: '',
                        r1: '', r2: '', r3: '', r4: ''
                    }));
                }
            };

            const handleSaveAsCourse = async () => {
                 if (!currentRecord.courseName) {
                    alert("è¯·å…ˆè¾“å…¥è¯¾ç¨‹åç§°ï¼");
                    return;
                }
                setIsLoading(true);
                try {
                    const Course = AV.Object.extend('CourseTemplate');
                    const course = new Course();
                    course.set('name', currentRecord.courseName);
                    course.set('age', currentRecord.age || '8');
                    course.set('r1', currentRecord.r1);
                    course.set('r2', currentRecord.r2);
                    course.set('r3', currentRecord.r3);
                    course.set('r4', currentRecord.r4);
                    
                    const saved = await course.save();
                    setCourses([...courses, { ...saved.attributes, id: saved.id }]);
                    alert(`è¯¾ç¨‹ã€Š${saved.get('name')}ã€‹å·²åŒæ­¥åˆ°äº‘ç«¯è¯¾ç¨‹åº“ï¼`);
                } catch (error) {
                    alert("ä¿å­˜è¯¾ç¨‹æ¨¡ç‰ˆå¤±è´¥: " + error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleDeleteRecord = async (id) => {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
                setIsLoading(true);
                try {
                    const record = AV.Object.createWithoutData('TeachingRecord', id);
                    await record.destroy();
                    setRecords(records.filter(r => r.id !== id));
                } catch (error) {
                    alert("åˆ é™¤å¤±è´¥: " + error.message);
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleClearAllRecords = async () => {
                if (records.length === 0) return;
                if (window.confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ¸…ç©ºäº‘ç«¯æ‰€æœ‰ ${records.length} æ¡è®°å½•å—ï¼Ÿ\n\nå»ºè®®åœ¨ã€å¯¼å‡ºExcelã€‘å¤‡ä»½åå†è¿›è¡Œæ­¤æ“ä½œã€‚\n\nç‚¹å‡»â€œç¡®å®šâ€å°†æ°¸ä¹…åˆ é™¤æ•°æ®ï¼`)) {
                    setIsLoading(true);
                    try {
                        const objectsToDelete = records.map(r => AV.Object.createWithoutData('TeachingRecord', r.id));
                        await AV.Object.destroyAll(objectsToDelete);
                        setRecords([]);
                        alert("å·²æ¸…ç©ºæ‰€æœ‰è®°å½•ã€‚");
                    } catch (error) {
                        alert("æ¸…ç©ºå¤±è´¥: " + error.message);
                    } finally {
                        setIsLoading(false);
                    }
                }
            };
            
            const handleAddClass = async () => {
                if(newClassInput && !savedClasses.find(c => c.name === newClassInput)) {
                    setIsLoading(true);
                    try {
                        const ClassObj = AV.Object.extend('ClassPreset');
                        const newClass = new ClassObj();
                        newClass.set('name', newClassInput);
                        const saved = await newClass.save();
                        setSavedClasses([...savedClasses, { name: saved.get('name'), id: saved.id }]);
                        setNewClassInput('');
                    } catch (error) {
                        alert("æ·»åŠ ç­çº§å¤±è´¥: " + error.message);
                    } finally {
                        setIsLoading(false);
                    }
                }
            };
            
            const handleDeleteClass = async (id, name) => {
                if(confirm(`ç¡®å®šè¦ä»äº‘ç«¯åˆ é™¤ç­çº§é¢„è®¾ "${name}" å—ï¼Ÿ`)) {
                    setIsLoading(true);
                    try {
                        const classObj = AV.Object.createWithoutData('ClassPreset', id);
                        await classObj.destroy();
                        setSavedClasses(savedClasses.filter(c => c.id !== id));
                    } catch (error) {
                        alert("åˆ é™¤ç­çº§å¤±è´¥: " + error.message);
                    } finally {
                        setIsLoading(false);
                    }
                }
            };

            const handleExportExcel = () => {
                const titleRow = [settings.title]; 
                const headerRow = ["åºå·", "è¯¾ç¨‹åç§°", "æˆè¯¾æ—¶é—´", "æˆè¯¾ç­çº§", "å¹´é¾„æ®µ", 
                    "æ•™å­¦åæ€1â€”æ•™å­¦ç›®æ ‡è®¾ç½®æ˜¯å¦åˆç†...", 
                    "æ•™å­¦åæ€2â€”â€”-æ€ç»´èƒ½åŠ›è®­ç»ƒç›®æ ‡è®¾ç½®...", 
                    "æ•™å­¦åæ€3â€”â€”è¯¾ç¨‹æµç¨‹/ç¯èŠ‚è®¾ç½®æ˜¯å¦...", 
                    "æ•™å­¦åæ€4â€”â€”-ä¸»ä½“æ­å»º/ç¼–ç¨‹ä»¥åŠåˆ›æ„..."
                ];
                // ä½¿ç”¨å®Œæ•´è¡¨å¤´åå¤ªé•¿ï¼Œè¿™é‡Œçœç•¥æ˜¾ç¤ºä½†å¯¼å‡ºä¿æŒå…¼å®¹ï¼ˆå®é™…åº”ä¸ä¹‹å‰ä¿æŒä¸€è‡´ï¼Œä¸ºä»£ç ç®€æ´æˆ‘ç•¥ä½œç¼©å‡å±•ç¤ºï¼Œé€»è¾‘ä¸å˜ï¼‰
                const fullHeaderRow = [
                    "åºå·", "è¯¾ç¨‹åç§°", "æˆè¯¾æ—¶é—´", "æˆè¯¾ç­çº§", "å¹´é¾„æ®µ", 
                    "æ•™å­¦åæ€1â€”æ•™å­¦ç›®æ ‡è®¾ç½®æ˜¯å¦åˆç†æˆ–éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†ï¼Œä¸ºä»€ä¹ˆï¼›è‹¥æ²¡æœ‰æ€»ç»“è¯¥éƒ¨åˆ†è®¾ç½®çš„å¥½çš„éƒ¨åˆ†ä»¥åŠåŸå› ", 
                    "æ•™å­¦åæ€2â€”â€”-æ€ç»´èƒ½åŠ›è®­ç»ƒç›®æ ‡è®¾ç½®æ˜¯å¦åˆç†æˆ–éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†ï¼Œä¸ºä»€ä¹ˆï¼‰ï¼›è‹¥æ²¡æœ‰æ€»ç»“è¯¥éƒ¨åˆ†è®¾ç½®çš„å¥½çš„éƒ¨åˆ†ä»¥åŠåŸå› ", 
                    "æ•™å­¦åæ€3â€”â€”è¯¾ç¨‹æµç¨‹/ç¯èŠ‚è®¾ç½®æ˜¯å¦åˆç†æˆ–éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†ï¼Œä¸ºä»€ä¹ˆï¼›\nè‹¥æ²¡æœ‰æ€»ç»“è¯¥éƒ¨åˆ†è®¾ç½®çš„å¥½çš„éƒ¨åˆ†ä»¥åŠåŸå› ", 
                    "æ•™å­¦åæ€4â€”â€”-ä¸»ä½“æ­å»º/ç¼–ç¨‹ä»¥åŠåˆ›æ„æ­å»º/ç¼–ç¨‹ç¯èŠ‚è®¾ç½®éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†ï¼Œä¸ºä»€ä¹ˆï¼‰ï¼›è‹¥æ²¡æœ‰æ€»ç»“è¯¥éƒ¨åˆ†è®¾ç½®çš„å¥½çš„éƒ¨åˆ†ä»¥åŠåŸå› "
                ];

                const sortedRecords = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
                const dataRows = sortedRecords.map((record, index) => [
                    index + 1, record.courseName, record.date, record.className, record.age,
                    record.r1, record.r2, record.r3, record.r4
                ]);

                const wsData = [titleRow, fullHeaderRow, ...dataRows];
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 8 } }];
                ws['!cols'] = [{ wch: 6 }, { wch: 20 }, { wch: 12 }, { wch: 15 }, { wch: 8 }, { wch: 40 }, { wch: 40 }, { wch: 40 }, { wch: 40 }];
                
                // Style applying logic ...
                const borderStyle = { top: { style: "thin", color: { rgb: "000000" } }, bottom: { style: "thin", color: { rgb: "000000" } }, left: { style: "thin", color: { rgb: "000000" } }, right: { style: "thin", color: { rgb: "000000" } } };
                const baseStyle = { alignment: { vertical: "center", wrapText: true }, font: { name: "å®‹ä½“", sz: 11 }, border: borderStyle };
                
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!ws[cell_address]) continue;
                        ws[cell_address].s = JSON.parse(JSON.stringify(baseStyle));
                        if (R === 0) { ws[cell_address].s.font = { name: "å®‹ä½“", sz: 16, bold: true }; ws[cell_address].s.alignment = { horizontal: "center", vertical: "center" }; }
                        if (R === 1) { ws[cell_address].s.font = { name: "å®‹ä½“", sz: 11, bold: true }; ws[cell_address].s.alignment = { horizontal: "center", vertical: "center", wrapText: true }; ws[cell_address].s.fill = { fgColor: { rgb: "EFEFEF" } }; }
                    }
                }
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "æ•™å­¦åæ€");
                XLSX.writeFile(wb, `æ•™å­¦åæ€_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            return (
                <div className="min-h-screen bg-gray-50 flex font-sans text-gray-800">
                    <AIModal isOpen={isAIModalOpen} onClose={() => setIsAIModalOpen(false)} onFillData={handleAIFillData} courseName={currentRecord.courseName} age={currentRecord.age} />
                    {isLoading && <div className="loading-overlay"><div className="flex flex-col items-center"><svg className="animate-spin h-10 w-10 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>å¤„ç†ä¸­...</span></div></div>}

                    {/* Sidebar */}
                    <div className="w-64 bg-slate-800 text-white flex flex-col p-4 shadow-xl shrink-0">
                        <h1 className="text-xl font-bold mb-8 flex items-center"><span className="mr-2"><IconCloud /></span> Veape Rethink<span className="text-xs bg-green-500 ml-2 px-1 rounded">Cloud</span></h1>
                        <nav className="flex-1 space-y-2">
                            <button onClick={() => setActiveTab('record')} className={`w-full flex items-center p-3 rounded-lg transition ${activeTab === 'record' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-gray-300'}`}><span className="mr-3"><IconEdit3 /></span> å¿«æ·è®°å½•</button>
                            <button onClick={() => setActiveTab('library')} className={`w-full flex items-center p-3 rounded-lg transition ${activeTab === 'library' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-gray-300'}`}><span className="mr-3"><IconFileText /></span> è¯¾ç¨‹åº“ç®¡ç†</button>
                            <button onClick={() => setActiveTab('settings')} className={`w-full flex items-center p-3 rounded-lg transition ${activeTab === 'settings' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-gray-300'}`}><span className="mr-3"><IconSettings /></span> ç³»ç»Ÿ/ç­çº§è®¾ç½®</button>
                        </nav>
                        <div className="mt-auto p-4 bg-slate-900 rounded text-sm text-gray-400">
                            <p>äº‘ç«¯è¯¾ç¨‹: {courses.length} ä¸ª</p>
                            <p>äº‘ç«¯ç­çº§: {savedClasses.length} ä¸ª</p>
                            <p>æœ¬å‘¨è®°å½•: {records.length} æ¡</p>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 p-8 overflow-y-auto">
                        {activeTab === 'record' && (
                            <div className="max-w-5xl mx-auto">
                                <header className="mb-6 flex justify-between items-end">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-800">æœ¬å‘¨ä¸Šè¯¾è®°å½•</h2>
                                        <p className="text-gray-500 text-sm mt-1">äº‘ç«¯åŒæ­¥ + AI æ™ºèƒ½è¾…åŠ© + éšæ—¶ç¼–è¾‘</p>
                                    </div>
                                    <button onClick={handleExportExcel} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow flex items-center font-medium transition"><span className="mr-2"><IconDownload /></span> å¯¼å‡º Excel åæ€è¡¨</button>
                                </header>

                                {/* Input Form */}
                                <div className={`bg-white rounded-xl shadow-sm border ${editingId ? 'border-yellow-400 ring-2 ring-yellow-100' : 'border-gray-200'} p-6 mb-8 relative transition-all duration-300`}>
                                    {editingId && (
                                        <div className="absolute -top-3 left-6 bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-full shadow flex items-center">
                                            <span>æ­£åœ¨ç¼–è¾‘æ¨¡å¼</span>
                                            <button onClick={handleCancelEdit} className="ml-2 hover:bg-yellow-500 rounded-full p-0.5"><IconX /></button>
                                        </div>
                                    )}
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">ä¸Šè¯¾æ—¥æœŸ</label>
                                            <input type="date" value={currentRecord.date} onChange={(e) => setCurrentRecord({...currentRecord, date: e.target.value})} className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">ç­çº§åç§°</label>
                                            <div className="flex">
                                                <input type="text" placeholder="å¦‚: Scratch16ç­" value={currentRecord.className} onChange={(e) => setCurrentRecord({...currentRecord, className: e.target.value})} className="w-full border border-gray-300 rounded-l-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                                <select onChange={handleClassSelect} className="w-10 border border-l-0 border-gray-300 rounded-r-md bg-gray-50 text-gray-600 focus:outline-none cursor-pointer" value=""><option value="" disabled>â–¼</option>{savedClasses.map(cls => (<option key={cls.id} value={cls.name}>{cls.name}</option>))}</select>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">å¹´é¾„æ®µ</label>
                                            <input type="text" placeholder="å¦‚: 8" value={currentRecord.age} onChange={(e) => setCurrentRecord({...currentRecord, age: e.target.value})} className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                        </div>
                                    </div>

                                    <div className="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100 relative">
                                        <label className="block text-sm font-bold text-blue-800 mb-2">è¯¾ç¨‹åç§°</label>
                                        <div className="flex gap-2 mb-2">
                                            <div className="flex-1 relative">
                                                <input type="text" placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°..." value={currentRecord.courseName} onChange={(e) => setCurrentRecord({...currentRecord, courseName: e.target.value})} className="w-full border border-gray-300 rounded-l-md p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none h-full"/>
                                            </div>
                                            <div className="w-1/3">
                                                <select onChange={handleTemplateSelect} className="w-full border border-gray-300 rounded-r-md p-2.5 bg-white text-gray-700 h-full focus:outline-none" value={currentRecord.courseId || ""}><option value="">â–¼ é€‰æ¨¡ç‰ˆ...</option>{courses.map(c => (<option key={c.id} value={c.id}>{c.name}</option>))}</select>
                                            </div>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <p className="text-xs text-blue-600 flex items-center"><span className="mr-1">ğŸ’¡</span> è¾“å…¥è¯¾ç¨‹å’Œç­çº§å³å¯ä¿å­˜ï¼Œåæ€å¯ç¨åè¡¥å¡«ã€‚</p>
                                            <button onClick={() => setIsAIModalOpen(true)} className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-sm px-4 py-1.5 rounded-full shadow hover:shadow-lg transition transform hover:scale-105 flex items-center font-bold"><IconMagic /> <span className="ml-1">AI è¾…åŠ©</span></button>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {[{key:'r1',label:'åæ€1: æ•™å­¦ç›®æ ‡'},{key:'r2',label:'åæ€2: æ€ç»´èƒ½åŠ›'},{key:'r3',label:'åæ€3: è¯¾ç¨‹æµç¨‹'},{key:'r4',label:'åæ€4: ç¼–ç¨‹/æ­å»º'}].map((field) => (
                                            <div key={field.key} className="relative">
                                                <label className="block text-xs font-semibold text-gray-500 uppercase mb-1 tracking-wider">{field.label}</label>
                                                <textarea value={currentRecord[field.key]} onChange={(e) => setCurrentRecord({...currentRecord, [field.key]: e.target.value})} className="w-full h-24 border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none transition-colors" placeholder="(é€‰å¡«) å¯åç»­ç¼–è¾‘è¡¥å……..."/>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="mt-6 flex justify-between items-center pt-4 border-t border-gray-100">
                                        <button onClick={handleSaveAsCourse} className="text-gray-500 hover:text-blue-600 text-sm flex items-center px-3 py-2 rounded hover:bg-gray-100 transition"><span className="mr-2"><IconSave /></span> åŒæ­¥åˆ°äº‘ç«¯è¯¾ç¨‹åº“</button>
                                        <div className="flex gap-3">
                                            {editingId && (
                                                <button onClick={handleCancelEdit} className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2.5 rounded-lg shadow-sm font-bold transition">å–æ¶ˆ</button>
                                            )}
                                            <button onClick={handleSaveRecord} className={`${editingId ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-600 hover:bg-blue-700'} text-white px-8 py-2.5 rounded-lg shadow-md flex items-center font-bold transition transform active:scale-95`}>
                                                {editingId ? <><span className="mr-2"><IconUpdate /></span> æ›´æ–°è®°å½•</> : <><span className="mr-2"><IconPlus /></span> ä¿å­˜åˆ°äº‘ç«¯</>}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Record List */}
                                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                        <h3 className="font-semibold text-gray-700">å¾…å¯¼å‡ºåˆ—è¡¨ (äº‘ç«¯: {records.length})</h3>
                                        {records.length > 0 && <button onClick={handleClearAllRecords} className="text-red-500 hover:text-red-700 text-sm flex items-center px-3 py-1 rounded hover:bg-red-50 transition border border-red-200 hover:border-red-300"><span className="mr-1"><IconTrash2 /></span> æ¸…ç©ºåˆ—è¡¨</button>}
                                    </div>
                                    {records.length === 0 ? (
                                        <div className="p-8 text-center text-gray-400">
                                            <div className="w-12 h-12 mx-auto mb-3 opacity-20"><IconCalendar /></div>
                                            <p>æš‚æ— è®°å½•ï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ </p>
                                        </div>
                                    ) : (
                                        <div className="divide-y divide-gray-100">
                                            {records.map((rec, idx) => (
                                                <div key={rec.id} className={`p-4 transition flex items-start group ${editingId === rec.id ? 'bg-yellow-50' : 'hover:bg-gray-50'}`}>
                                                    <div className="w-10 pt-1 font-mono text-gray-400 text-sm">#{idx + 1}</div>
                                                    <div className="flex-1 grid grid-cols-1 md:grid-cols-12 gap-4">
                                                        <div className="md:col-span-3">
                                                            <p className="font-bold text-gray-800">{rec.courseName}</p>
                                                            <p className="text-xs text-gray-500">{rec.date} | {rec.className} | {rec.age}å²</p>
                                                        </div>
                                                        <div className="md:col-span-8 text-sm text-gray-600 space-y-1">
                                                            {!rec.r1 && !rec.r4 ? (
                                                                <span className="text-gray-400 italic">ï¼ˆåæ€å†…å®¹å¾…è¡¥å……...ï¼‰</span>
                                                            ) : (
                                                                <>
                                                                    <p className="line-clamp-1"><span className="text-blue-600 font-medium">ç›®æ ‡:</span> {rec.r1 || '-'}</p>
                                                                    <p className="line-clamp-1"><span className="text-purple-600 font-medium">ç¼–ç¨‹:</span> {rec.r4 || '-'}</p>
                                                                </>
                                                            )}
                                                        </div>
                                                        <div className="md:col-span-1 flex justify-end items-center gap-2 opacity-0 group-hover:opacity-100 transition">
                                                            <button onClick={() => handleEditRecord(rec)} className="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50" title="ç¼–è¾‘"><IconEdit3 /></button>
                                                            <button onClick={() => handleDeleteRecord(rec.id)} className="text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50" title="åˆ é™¤"><IconTrash2 /></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        {/* Library & Settings Tabs */}
                        {activeTab === 'library' && (
                            <div className="max-w-4xl mx-auto">
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">äº‘ç«¯è¯¾ç¨‹æ¨¡ç‰ˆåº“</h2>
                                <div className="grid gap-6">
                                    {courses.map(c => (
                                        <div key={c.id} className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 className="text-lg font-bold text-gray-900">{c.name}</h3>
                                                    <span className="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded mt-1">
                                                        é€‚åˆå¹´é¾„: {c.age}å²
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                                                <div className="bg-gray-50 p-3 rounded"><span className="font-bold block text-gray-800 mb-1">ç›®æ ‡:</span> {c.r1}</div>
                                                <div className="bg-gray-50 p-3 rounded"><span className="font-bold block text-gray-800 mb-1">æ€ç»´:</span> {c.r2}</div>
                                                <div className="bg-gray-50 p-3 rounded"><span className="font-bold block text-gray-800 mb-1">æµç¨‹:</span> {c.r3}</div>
                                                <div className="bg-gray-50 p-3 rounded"><span className="font-bold block text-gray-800 mb-1">ç¼–ç¨‹:</span> {c.r4}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {activeTab === 'settings' && (
                            <div className="max-w-2xl mx-auto">
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">ç³»ç»Ÿ/ç­çº§è®¾ç½®</h2>
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center"><IconEdit3 /> <span className="ml-2">å¯¼å‡ºæ ‡é¢˜è®¾ç½®</span></h3>
                                        <div><label className="block text-sm font-medium text-gray-700 mb-1">è¡¨æ ¼æ ‡é¢˜ (Excelç¬¬ä¸€è¡Œ)</label><input type="text" value={settings.title} onChange={(e) => setSettings({...settings, title: e.target.value})} className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500"/></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center"><IconUser /> <span className="ml-2">äº‘ç«¯é¢„è®¾ç­çº§ç®¡ç†</span></h3>
                                        <div className="mb-4 flex gap-2"><input type="text" placeholder="è¾“å…¥æ–°ç­çº§åç§°" value={newClassInput} onChange={(e) => setNewClassInput(e.target.value)} className="flex-1 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500"/><button onClick={handleAddClass} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium">æ·»åŠ </button></div>
                                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-100"><div className="text-xs text-gray-500 mb-2">äº‘ç«¯é¢„è®¾ç­çº§ï¼š</div><div className="flex flex-wrap gap-2">{savedClasses.map(cls => (<span key={cls.id} className="bg-white border border-gray-300 rounded-full px-3 py-1 text-sm flex items-center group">{cls.name}<button onClick={() => handleDeleteClass(cls.id, cls.name)} className="ml-2 text-gray-400 hover:text-red-500">&times;</button></span>))}</div></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>