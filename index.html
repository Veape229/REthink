<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°‘å„¿ç¼–ç¨‹æ•™å­¦ç³»ç»Ÿ V6.4 (æ”¯æŒè¡¨æ ¼å¯¼å…¥)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS with Style Support (xlsx-js-style) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 50;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; color: #3b82f6; font-weight: bold;
        }
        .ai-modal { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .pre-wrap { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- LeanCloud åˆå§‹åŒ– ---
        const APP_ID = 'Sx1nSaU2TUCAbzB29iLyrRai-gzGzoHsz';
        const APP_KEY = 'dn5qcsJvY3BetbUMnEgAJNtn';
        const SERVER_URL = 'https://sx1nsau2.lc-cn-n1-shared.com';

        if (!AV.applicationId) {
            AV.init({
                appId: APP_ID,
                appKey: APP_KEY,
                serverURL: SERVER_URL
            });
        }

        // --- åˆå§‹æ•°æ® (æ ¹æ®ç”¨æˆ·ä¸Šä¼ çš„ CSV é¢„è§ˆæå–) ---
        const INITIAL_INTERPRETATIONS_DATA = [
            {
                name: "1-æ˜Ÿé™…è¿·èˆª1",
                content: `ã€ç¬¬1èŠ‚è¯¾-è¯¾ç¨‹è§£è¯»ã€‘\nğŸ”¹ è¯¾ç¨‹ä¸»é¢˜\næœ¬èŠ‚è¯¾ä¸»é¢˜ï¼šã€Šæ˜Ÿé™…è¿·èˆª1_é€ƒç¦»åœ°çƒã€‹\nğŸ”¹ è¯¾ç¨‹ç›®æ ‡\nçŸ¥è¯†ç›®æ ‡ï¼š\nå­¦ä¹ é¼ æ ‡ã€é”®ç›˜çš„æ“ä½œï¼Œè®¤è¯†Scratchçš„äº”å¤§åˆ†åŒºåç§°ä»¥åŠåŠŸèƒ½ã€åŸºæœ¬ç¨‹åºç¼–å†™çš„é¡ºåºã€ç¨‹åºè§’è‰²çš„åˆå§‹åŒ–ã€‚åˆæ­¥äº†è§£ç¨‹åºä¸­è§’è‰²çš„åæ ‡ï¼ˆç®€å•ä»‹ç»ï¼‰ä»¥åŠæ–¹å‘ã€‚\n \næ€ç»´ç›®æ ‡ï¼š\né€»è¾‘æ¨ç†èƒ½åŠ›ï¼šé€šè¿‡è®¾ç½®è§’è‰²â€œåˆå§‹åŒ–-ç§»åŠ¨-å¯¹è¯â€çš„ä»»åŠ¡é¡ºåºï¼Œå¼•å¯¼å­©å­åˆ†æâ€œè§’è‰²ç§»åŠ¨éœ€è¦å“ªäº›æŒ‡ä»¤é…åˆï¼Ÿâ€â€œæ–¹å‘é”™è¯¯ä¼šå¯¼è‡´ä»€ä¹ˆç»“æœï¼Ÿâ€ï¼Œé€æ­¥æ¨å¯¼å‡ºâ€œæ–¹å‘è®¾ç½®â†’åæ ‡å˜åŒ–â†’ç¨‹åºæ‰§è¡Œâ€çš„é€»è¾‘å…³ç³»ğŸ§©ï¼›\n \né—®é¢˜è§£å†³èƒ½åŠ›ï¼šåœ¨è°ƒè¯•ç¨‹åºæ—¶ï¼Œé’ˆå¯¹â€œè§’è‰²ä¸ç§»åŠ¨â€â€œç§»åŠ¨æ–¹å‘ç›¸åâ€ç­‰å¸¸è§é—®é¢˜ï¼Œé¼“åŠ±è‡ªä¸»æ’æŸ¥åŸå› ï¼Œå¹¶å°è¯•è°ƒæ•´ç¨‹åºè§£å†³é—®é¢˜ğŸ”`
            },
            {
                name: "2-æ˜Ÿé™…è¿·èˆª2",
                content: `ã€ç¬¬2èŠ‚è¯¾-è¯¾ç¨‹è§£è¯»ã€‘\nğŸ”¹ è¯¾ç¨‹ä¸»é¢˜\næœ¬èŠ‚è¯¾ä¸»é¢˜ï¼šã€Šæ˜Ÿé™…è¿·èˆª2_é­é‡å¤–æ˜Ÿäººã€‹\nğŸ”¹ è¯¾ç¨‹ç›®æ ‡\nçŸ¥è¯†ç›®æ ‡ï¼šç¨‹åºä¸­è§’è‰²çš„éšè—ä¸æ˜¾ç¤ºã€é‡å¤æ‰§è¡ŒæŒ‡ä»¤ï¼ˆå¾ªç¯ç»“æ„ï¼‰ã€ç¨‹åºèƒŒæ™¯çš„åˆ‡æ¢ã€‚\næ€ç»´ç›®æ ‡ï¼šåŸ¹å…»é€»è¾‘æ€ç»´ï¼ˆè®¡ç®—ç¨‹åºæ‰§è¡Œæ—¶é—´ï¼ŒæŒæ¡ç¨‹åºæ‰§è¡Œæµç¨‹ï¼‰ï¼Œé—®é¢˜è§£å†³èƒ½åŠ›`
            },
            {
                name: "1-æ”€çˆ¬æœºå™¨äºº",
                content: `ã€æœ¬æœŸå•ç‰‡æœºè¯¾ç¨‹è§£è¯»ã€‘\n1ï¸âƒ£è¯¾ç¨‹ä¸»é¢˜ï¼š\næœ¬æœŸè¯¾ç¨‹ä¸»é¢˜â€”â€”ã€Šæ”€çˆ¬æœºå™¨äººã€‹\n\n2ï¸âƒ£è¯¾ç¨‹ç›®æ ‡\nçŸ¥è¯†ç›®æ ‡ï¼šäº†è§£éº¦å…‹çº³å§†è½®çš„ç‰¹ç‚¹ï¼Œä»¥åŠå…¶ä»–ä¸åŒç§ç±»çš„è½®å­ï¼ˆä¸‡å‘è½®ã€å…¨å‘è½®ï¼‰\næ€ç»´ç›®æ ‡ï¼šåŸ¹å…»å­¦ç”Ÿåˆ†æé—®é¢˜çš„èƒ½åŠ›ï¼Œè®­ç»ƒç¼–ç¨‹æ€ç»´ã€ç©ºé—´æ€ç»´ã€é€»è¾‘æ€ç»´ã€è°ƒè¯•ç¨‹åºå¹¶è§£å†³é—®é¢˜çš„èƒ½åŠ›\n\n3ï¸âƒ£è¯¾ç¨‹é‡éš¾ç‚¹ï¼š\nâœ…ã€éœ€è¦æŒæ¡çš„æ ¸å¿ƒå†…å®¹ã€‘\næ­å»ºï¼šéº¦å…‹çº³å§†è½®çš„ä½¿ç”¨ã€ä¼ºæœé©¬è¾¾çš„å®‰è£…ä½¿ç”¨\nâš ï¸ã€éš¾ç‚¹ã€‘å¯¹ä½œå“æå‰æå‰ç©ºé—´è§„åˆ’ã€ä»¥åŠåœ¨æ­å»ºè¿‡ç¨‹ä¸­æå‰é¢„ç•™é©¬è¾¾çš„å®‰è£…ä½ç½®ã€éº¦è½®è¿æ¥çš„ç‰¹ç‚¹\nğŸŒŸã€æ‹“å±•ã€‘ç¼–ç¨‹ä¸ç¡¬ä»¶ç»“åˆï¼Œå°è¯•åˆ¶ä½œå‡ºç›¸åº”åŠŸèƒ½çš„æ”€çˆ¬æœºå™¨äºº`
            },
            {
                name: "2-æ±‰å ¡æœºå™¨äºº",
                content: `ã€æœ¬æœŸå•ç‰‡æœºè¯¾ç¨‹è§£è¯»ã€‘\n1ï¸âƒ£è¯¾ç¨‹ä¸»é¢˜ï¼š\næœ¬æœŸè¯¾ç¨‹ä¸»é¢˜â€”â€”ã€Šæ±‰å ¡æœºå™¨äººã€‹\n\n2ï¸âƒ£è¯¾ç¨‹ç›®æ ‡\nçŸ¥è¯†ç›®æ ‡ï¼šè®¤è¯†çº¢å¤–ä¼ æ„Ÿå™¨ã€è¶…å£°æ³¢ä¼ æ„Ÿå™¨å‚æ•°ä»¥åŠè¿è¡Œé€»è¾‘\næ€ç»´ç›®æ ‡ï¼šåŸ¹å…»å­¦ç”Ÿåˆ†æé—®é¢˜çš„èƒ½åŠ›ï¼Œè®­ç»ƒç¼–ç¨‹æ€ç»´ã€ç©ºé—´æ€ç»´ã€é€»è¾‘æ€ç»´ã€è°ƒè¯•ç¨‹åºå¹¶è§£å†³é—®é¢˜çš„èƒ½åŠ›\n\n3ï¸âƒ£è¯¾ç¨‹é‡éš¾ç‚¹ï¼š\nâœ…ã€éœ€è¦æŒæ¡çš„æ ¸å¿ƒå†…å®¹ã€‘\næ­å»ºï¼šä¼ æ„Ÿå™¨çš„ç¨‹åºè®¾è®¡é€»è¾‘ä»¥åŠä¸å•ç‰‡æœºçš„ç»“åˆä½¿ç”¨\nâš ï¸ã€éš¾ç‚¹ã€‘å¯¹ä½œå“æå‰æå‰ç©ºé—´è§„åˆ’ã€ç¨‹åºè®¾è®¡ä¸­ï¼Œå¯¹äºè¶…å£°æ³¢ä¼ æ„Ÿå™¨çš„å‚æ•°åˆ¤æ–­ç¨‹åºè®¾ç½®\nğŸŒŸã€æ‹“å±•ã€‘ç¼–ç¨‹ä¸ç¡¬ä»¶ç»“åˆï¼Œä¿®æ”¹çº¢å¤–ä¼ æ„Ÿå™¨ä¸ºæŒ‰é’®ï¼Œå¹¶ä¸”ä¿®æ”¹å¯¹åº”ç¨‹åº`
            }
        ];

        // --- å›¾æ ‡ç»„ä»¶ ---
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const IconTrash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const IconEdit3 = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>;
        const IconFileText = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const IconSave = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const IconUser = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const IconCloud = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>;
        const IconMagic = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>;
        const IconCopy = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const IconCalendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const IconUpdate = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>;
        const IconMessage = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>;
        const IconSearch = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;

        // --- AI åŠ©æ‰‹æ¨¡æ€æ¡† (åŸç‰ˆ - ç”¨äºåæ€) ---
        const AIModal = ({ isOpen, onClose, onFillData, courseName, age }) => {
            const [step, setStep] = useState(1);
            const [planText, setPlanText] = useState('');
            const [aiResult, setAiResult] = useState('');
            const [generatedPrompt, setGeneratedPrompt] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);

            if (!isOpen) return null;

            const handleGeneratePrompt = () => {
                if (!planText.trim()) { alert("è¯·å…ˆç²˜è´´æ•™æ¡ˆå†…å®¹ï¼"); return; }
                const prompt = `æˆ‘æ˜¯ä¸€åå°‘å„¿ç¼–ç¨‹è€å¸ˆï¼Œè¯·æ ¹æ®ä»¥ä¸‹æ•™æ¡ˆå†…å®¹ï¼Œä¸ºã€Š${courseName || 'å°‘å„¿ç¼–ç¨‹'}ã€‹è¯¾ç¨‹ï¼ˆ${age || '8'}å²ï¼‰æ’°å†™æ•™å­¦åæ€ã€‚
è¯·ä¸¥æ ¼ä¸”**åª**è¿”å›ä»¥ä¸‹JSONæ ¼å¼ï¼ˆä¸è¦åŒ…å«Markdownä»£ç å—æ ‡è®°ï¼‰ï¼š
{"r1": "é’ˆå¯¹æ•™å­¦ç›®æ ‡çš„ç®€çŸ­åæ€(50å­—)", "r2": "é’ˆå¯¹æ€ç»´èƒ½åŠ›è®­ç»ƒçš„ç®€çŸ­åæ€(50å­—)", "r3": "é’ˆå¯¹è¯¾ç¨‹æµç¨‹/ç¯èŠ‚çš„åæ€(50å­—)", "r4": "é’ˆå¯¹ç¼–ç¨‹/æ­å»ºç¯èŠ‚çš„åæ€(50å­—)"}

æ•™æ¡ˆå†…å®¹ï¼š
${planText}`;
                setGeneratedPrompt(prompt);
                setStep(2);
            };

            const handleCopyPrompt = () => {
                navigator.clipboard.writeText(generatedPrompt);
                setCopySuccess(true);
                setTimeout(() => setCopySuccess(false), 2000);
            };

            const handleParseResult = () => {
                try {
                    let cleanJson = aiResult.trim();
                    if (cleanJson.startsWith('```json')) { cleanJson = cleanJson.replace(/^```json/, '').replace(/```$/, ''); } 
                    else if (cleanJson.startsWith('```')) { cleanJson = cleanJson.replace(/^```/, '').replace(/```$/, ''); }
                    const data = JSON.parse(cleanJson);
                    if (data.r1 || data.r2 || data.r3 || data.r4) {
                        onFillData(data); onClose(); setStep(1); setPlanText(''); setAiResult(''); setGeneratedPrompt('');
                    } else { alert("è§£æå¤±è´¥ï¼šAIè¿”å›çš„æ ¼å¼ä¼¼ä¹ä¸å¯¹ã€‚"); }
                } catch (e) { alert("è§£æé”™è¯¯ï¼šè¯·ç¡®è®¤ä½ ç²˜è´´çš„æ˜¯AIç”Ÿæˆçš„JSONä»£ç ã€‚"); }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto ai-modal">
                        <div className="bg-gradient-to-r from-purple-600 to-blue-600 p-4 rounded-t-xl flex justify-between items-center text-white">
                            <h3 className="text-xl font-bold flex items-center"><IconMagic /> <span className="ml-2">AI æ™ºèƒ½åæ€åŠ©æ‰‹</span></h3>
                            <button onClick={onClose} className="hover:bg-white hover:bg-opacity-20 rounded-full p-1">&times;</button>
                        </div>
                        <div className="p-6">
                            {step === 1 ? (
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">ç¬¬ä¸€æ­¥ï¼šè¾“å…¥æ•™æ¡ˆ/è¯¾ç¨‹é‡ç‚¹</h4>
                                    <textarea className="w-full h-40 border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder="ç²˜è´´æ•™æ¡ˆ..." value={planText} onChange={(e) => setPlanText(e.target.value)}></textarea>
                                    <div className="mt-4 flex justify-end">
                                        <button onClick={handleGeneratePrompt} className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg shadow font-medium">ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆ AI æŒ‡ä»¤</button>
                                    </div>
                                </div>
                            ) : (
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">ç¬¬äºŒæ­¥ï¼šå¤åˆ¶æŒ‡ä»¤å‘ç»™ AIï¼Œå¹¶å›å¡«ç»“æœ</h4>
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 relative"><p className="text-xs text-gray-500 uppercase font-bold mb-1">ç»™ AI çš„æŒ‡ä»¤</p><div className="text-xs text-gray-600 max-h-24 overflow-y-auto whitespace-pre-wrap font-mono">{generatedPrompt}</div><button onClick={handleCopyPrompt} className={`absolute top-2 right-2 px-3 py-1 rounded text-sm transition ${copySuccess ? 'bg-green-100 text-green-700' : 'bg-white border text-gray-700'}`}>{copySuccess ? 'å·²å¤åˆ¶' : 'å¤åˆ¶'}</button></div>
                                    <div className="w-full"><label className="block text-sm font-bold text-gray-700 mb-2">ç²˜è´´ AI å›å¤ï¼š</label><textarea className="w-full h-32 border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none font-mono" placeholder='{"r1": "...", "r2": "..."}' value={aiResult} onChange={(e) => setAiResult(e.target.value)}></textarea></div>
                                    <div className="mt-6 flex justify-between items-center"><button onClick={() => setStep(1)} className="text-gray-500 hover:text-gray-700 text-sm underline">â† è¿”å›</button><button onClick={handleParseResult} disabled={!aiResult} className={`px-6 py-2 rounded-lg shadow font-bold flex items-center transition ${!aiResult ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'}`}>æ™ºèƒ½è§£æå¹¶å¡«è¡¨</button></div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- è¯¾ç¨‹è§£è¯»ä¸“å± AI æ¨¡æ€æ¡† (å¢å¼ºç‰ˆ - é€‚é…è¡¨3æ¨¡æ¿) ---
        const InterpretationAIModal = ({ isOpen, onClose, onFinish }) => {
            const [step, setStep] = useState(1);
            const [planText, setPlanText] = useState('');
            const [courseName, setCourseName] = useState('');
            const [lessonNum, setLessonNum] = useState('');
            const [aiResult, setAiResult] = useState('');
            const [generatedPrompt, setGeneratedPrompt] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);

            if (!isOpen) return null;

            const handleGeneratePrompt = () => {
                if (!planText.trim()) { alert("è¯·å…ˆç²˜è´´æ•™æ¡ˆå†…å®¹ï¼"); return; }
                
                // æ ¸å¿ƒï¼šé€‚é…è¡¨3æ¨¡æ¿çš„ Prompt
                const prompt = `ä½ æ˜¯ä¸€åä¸“ä¸šçš„å°‘å„¿ç¼–ç¨‹è€å¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹ã€æ•™æ¡ˆå†…å®¹ã€‘ï¼Œå‚è€ƒã€è¾“å‡ºæ¨¡æ¿ã€‘ï¼Œä¸ºå®¶é•¿æ’°å†™ä¸€ä»½ã€Š${courseName || 'å°‘å„¿ç¼–ç¨‹'}ã€‹çš„è¯¾ç¨‹è§£è¯»ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ã€è¾“å‡ºæ¨¡æ¿ã€‘çš„ç»“æ„å’Œæ ¼å¼ç”Ÿæˆï¼ˆä¿æŒ emojisã€æ¢è¡Œå’Œå±‚çº§ï¼‰ï¼Œä¸è¦åªç”Ÿæˆä¸€æ®µè¯ï¼Œè¦ç»“æ„åŒ–è¾“å‡ºï¼š

ã€è¾“å‡ºæ¨¡æ¿ã€‘
ã€ç¬¬ ${lessonNum || 'X'} èŠ‚è¯¾ - è¯¾ç¨‹è§£è¯»ã€‘

ğŸ”¹ è¯¾ç¨‹ä¸»é¢˜ï¼šã€Š${courseName || '[è¯¾ç¨‹åç§°]'}ã€‹

ğŸ”¹ è¯¾ç¨‹ç›®æ ‡ï¼š

âœ… çŸ¥è¯†ç›®æ ‡ 
æ ¸å¿ƒç¼–ç¨‹æŠ€èƒ½ï¼š
[æ¦‚å¿µåç§°]ï¼š [ç®€è¿°æ¦‚å¿µå®šä¹‰ï¼Œä¾‹å¦‚ï¼šç†è§£â€œå¾ªç¯â€ï¼Œå³é‡å¤æ‰§è¡ŒæŸæ®µæŒ‡ä»¤]
[æ“ä½œæŠ€èƒ½]ï¼š [ç®€è¿°å…·ä½“æ“ä½œï¼Œä¾‹å¦‚ï¼šé€šè¿‡åæ ‡(x,y)æ§åˆ¶è§’è‰²ç§»åŠ¨ / ä½¿ç”¨ä¾¦æµ‹æ¨¡å—åˆ¤æ–­ç¢°æ’]
[é«˜çº§æœºåˆ¶]ï¼š [å¦‚ï¼šå¹¿æ’­ã€å˜é‡ã€å…‹éš†ç­‰ï¼Œè‹¥æœ‰åˆ™å†™ï¼Œæ— åˆ™ç•¥è¿‡]

è·¨å­¦ç§‘/æ‹“å±•çŸ¥è¯†ï¼š
[å­¦ç§‘åç§°]ï¼š [å…³è”çš„å­¦ç§‘çŸ¥è¯†ç‚¹ï¼Œå¦‚ï¼šæ•°å­¦åæ ‡ç³» / ç‰©ç†é‡åŠ› / è‡ªç„¶ç§‘å­¦å¸¸è¯†]

ğŸ§© æ€ç»´ç›®æ ‡
é€»è¾‘æ€ç»´èƒ½åŠ› (æ‹†è§£ä¸æ¨å¯¼)ï¼š
[ä»»åŠ¡æ‹†è§£]ï¼šå¼•å¯¼å­©å­å°†å¤§é—®é¢˜æ‹†è§£ä¸ºå°æ­¥éª¤ã€‚ä¾‹å¦‚ï¼šâ€œå¦‚ä½•å®ç° [åŠŸèƒ½A] ï¼Ÿâ€ â†’ å¯¹åº” [ç¼–ç¨‹é€»è¾‘A]ã€‚
[é€»è¾‘é—­ç¯]ï¼šåŸ¹å…»â€œå‘ç°é—®é¢˜ â†’ é€»è¾‘æ¨å¯¼ â†’ ä»£ç å®ç°â€çš„èƒ½åŠ›ã€‚

ç³»ç»Ÿæ€§æ€ç»´ (ç»“æ„ä¸æµç¨‹)ï¼š
[æ¨¡å—åŒ–è®¾è®¡]ï¼šç†è§£ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼ˆåˆå§‹åŒ– -> è¿è¡Œ -> ç»“æŸï¼‰ã€‚

ğŸŒ è·¨å­¦ç§‘æ€ç»´èåˆ
[é¢†åŸŸ]ï¼š[å¦‚ä½•ç”¨ç¼–ç¨‹è§£é‡Šå­¦ç§‘ç°è±¡ï¼Œä¾‹å¦‚ï¼šç”¨å˜é‡æ¨¡æ‹Ÿç‰©ç†åŠ é€Ÿåº¦]

ğŸ”¹ å®¶é•¿äº’åŠ¨å»ºè®®
1ï¸âƒ£ â€œå°è€å¸ˆâ€å¤ç›˜ï¼š[å»ºè®®å®¶é•¿é—®å­©å­ä¸€ä¸ªå…·ä½“çš„é—®é¢˜ï¼Œè®©å­©å­å½“å°è€å¸ˆæ¥è§£é‡Š]
2ï¸âƒ£ ç”Ÿæ´»åœºæ™¯è¿ç§»ï¼š[ç»™å‡ºä¸€ä¸ªç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼Œå¸®åŠ©å­©å­ç†è§£ä»Šå¤©çš„ç¼–ç¨‹æ¦‚å¿µ]

ã€æ•™æ¡ˆå†…å®¹ã€‘
${planText}`;
                
                setGeneratedPrompt(prompt);
                setStep(2);
            };

            const handleCopyPrompt = () => {
                navigator.clipboard.writeText(generatedPrompt);
                setCopySuccess(true);
                setTimeout(() => setCopySuccess(false), 2000);
            };

            const handleFinish = () => {
                if (aiResult.trim()) {
                    onFinish(courseName || 'æœªå‘½åè¯¾ç¨‹', aiResult);
                    onClose();
                    setStep(1); setPlanText(''); setAiResult(''); setCourseName(''); setLessonNum('');
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto ai-modal">
                        <div className="bg-gradient-to-r from-orange-500 to-red-500 p-4 rounded-t-xl flex justify-between items-center text-white">
                            <h3 className="text-xl font-bold flex items-center"><IconMessage /> <span className="ml-2">è¯¾ç¨‹è§£è¯»ç”ŸæˆåŠ©æ‰‹ (è¡¨3æ ‡å‡†ç‰ˆ)</span></h3>
                            <button onClick={onClose} className="hover:bg-white hover:bg-opacity-20 rounded-full p-1">&times;</button>
                        </div>
                        <div className="p-6">
                            {step === 1 ? (
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">ç¬¬ä¸€æ­¥ï¼šè¾“å…¥è¯¾ç¨‹ä¿¡æ¯ä¸æ•™æ¡ˆ</h4>
                                    <div className="grid grid-cols-4 gap-4 mb-3">
                                        <div className="col-span-3">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">è¯¾ç¨‹åç§°</label>
                                            <input type="text" className="w-full border border-gray-300 rounded p-2 focus:outline-none focus:border-orange-500" placeholder="ä¾‹å¦‚ï¼šæ‰“åœ°é¼ " value={courseName} onChange={(e)=>setCourseName(e.target.value)} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">è¯¾æ—¶</label>
                                            <input type="number" className="w-full border border-gray-300 rounded p-2 focus:outline-none focus:border-orange-500" placeholder="1" value={lessonNum} onChange={(e)=>setLessonNum(e.target.value)} />
                                        </div>
                                    </div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">æ•™æ¡ˆå†…å®¹ / çŸ¥è¯†ç‚¹</label>
                                    <textarea className="w-full h-32 border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-orange-500 focus:outline-none" placeholder="ç²˜è´´ç³»ç»Ÿæ•™æ¡ˆæˆ–æœ¬èŠ‚è¯¾é‡ç‚¹..." value={planText} onChange={(e) => setPlanText(e.target.value)}></textarea>
                                    <div className="mt-4 flex justify-end">
                                        <button onClick={handleGeneratePrompt} className="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg shadow font-medium">ç”Ÿæˆ AI æŒ‡ä»¤</button>
                                    </div>
                                </div>
                            ) : (
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">ç¬¬äºŒæ­¥ï¼šè·å–è§£è¯»å¹¶å…¥åº“</h4>
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 relative"><p className="text-xs text-gray-500 uppercase font-bold mb-1">æç¤ºè¯ (åŒ…å«è¡¨3æ¨¡æ¿è¦æ±‚)</p><div className="text-xs text-gray-600 max-h-24 overflow-y-auto whitespace-pre-wrap font-mono">{generatedPrompt}</div><button onClick={handleCopyPrompt} className={`absolute top-2 right-2 px-3 py-1 rounded text-sm transition ${copySuccess ? 'bg-green-100 text-green-700' : 'bg-white border text-gray-700'}`}>{copySuccess ? 'å·²å¤åˆ¶' : 'å¤åˆ¶'}</button></div>
                                    <div className="w-full"><label className="block text-sm font-bold text-gray-700 mb-2">ç²˜è´´ AI ç”Ÿæˆçš„è§£è¯»ï¼š</label><textarea className="w-full h-48 border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-orange-500 focus:outline-none pre-wrap" placeholder="ã€ç¬¬ 1 èŠ‚è¯¾ - è¯¾ç¨‹è§£è¯»ã€‘..." value={aiResult} onChange={(e) => setAiResult(e.target.value)}></textarea></div>
                                    <div className="mt-6 flex justify-between items-center"><button onClick={() => setStep(1)} className="text-gray-500 hover:text-gray-700 text-sm underline">â† è¿”å›</button><button onClick={handleFinish} disabled={!aiResult} className={`px-6 py-2 rounded-lg shadow font-bold flex items-center transition ${!aiResult ? 'bg-gray-300 cursor-not-allowed' : 'bg-orange-600 hover:bg-orange-700 text-white'}`}>ä¿å­˜åˆ°è§£è¯»åº“</button></div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ä¸»åº”ç”¨ç»„ä»¶ ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('record');
            const [isLoading, setIsLoading] = useState(false);
            const fileInputRef = useRef(null);
            
            // æ¨¡æ€æ¡†çŠ¶æ€
            const [isAIModalOpen, setIsAIModalOpen] = useState(false); // åæ€ AI
            const [isInterpAIModalOpen, setIsInterpAIModalOpen] = useState(false); // è§£è¯» AI
            
            // æ•°æ® State
            const [courses, setCourses] = useState([]);
            const [records, setRecords] = useState([]);
            const [savedClasses, setSavedClasses] = useState([]);
            const [interpretations, setInterpretations] = useState([]); // è§£è¯»åº“
            
            // ç¼–è¾‘æ¨¡å¼ State
            const [editingId, setEditingId] = useState(null);
            
            // è¾“å…¥ State
            const [newClassInput, setNewClassInput] = useState('');
            const [searchTerm, setSearchTerm] = useState(''); // è§£è¯»æœç´¢
            const [selectedInterpId, setSelectedInterpId] = useState(null); // å½“å‰é€‰ä¸­çš„è§£è¯»ID

            const [settings, setSettings] = useState({
                title: 'ä¹äº«æœªæ¥ 12æœˆ æœˆåº¦æ•™å­¦åæ€è¡¨â€”â€”æäº¤äººï¼šéŸ¦çƒ¨',
                defaultClass: 'Scratch16ç­',
                defaultAge: '8'
            });

            const [currentRecord, setCurrentRecord] = useState({
                date: new Date().toISOString().split('T')[0],
                className: '',
                courseId: '',
                courseName: '', 
                age: '',
                r1: '', r2: '', r3: '', r4: ''
            });

            // --- æ•°æ®åŠ è½½é€»è¾‘ ---
            useEffect(() => {
                const initData = async () => {
                    setIsLoading(true);
                    
                    // 1. è¯¾ç¨‹æ¨¡ç‰ˆ (Safe Init)
                    try {
                        const courseQuery = new AV.Query('CourseTemplate');
                        const courseResults = await courseQuery.limit(100).find();
                        setCourses(courseResults.map(r => ({ ...r.attributes, id: r.id })));
                    } catch (error) {
                        console.warn("CourseTemplate init error (ignored):", error);
                        setCourses([]);
                    }

                    // 2. ç­çº§é¢„è®¾ (Safe Init)
                    try {
                        const classQuery = new AV.Query('ClassPreset');
                        const classResults = await classQuery.limit(100).find();
                        setSavedClasses(classResults.map(r => ({ name: r.get('name'), id: r.id })));
                    } catch (error) {
                         console.warn("ClassPreset init error (ignored):", error);
                         setSavedClasses([]);
                    }

                    // 3. ä¸Šè¯¾è®°å½• (Safe Init)
                    try {
                        const recordQuery = new AV.Query('TeachingRecord');
                        recordQuery.descending('createdAt'); 
                        const recordResults = await recordQuery.limit(500).find();
                        setRecords(recordResults.map(r => ({ ...r.attributes, id: r.id })));
                    } catch (error) {
                         console.warn("TeachingRecord init error (ignored):", error);
                         setRecords([]);
                    }

                    // 4. è¯¾ç¨‹è§£è¯»åº“ (å¸¦å®‰å…¨åˆå§‹åŒ–é€»è¾‘)
                    let interpResults = [];
                    try {
                        const interpQuery = new AV.Query('CourseInterpretation');
                        interpQuery.descending('createdAt');
                        interpResults = await interpQuery.limit(200).find();
                    } catch (error) {
                        console.log("CourseInterpretation query failed (likely Class missing). Initializing default data...");
                        interpResults = [];
                    }
                    
                    if (interpResults.length === 0) {
                        // åˆå§‹åŒ–å†…ç½®æ•°æ®
                        const initInterps = INITIAL_INTERPRETATIONS_DATA.map(d => {
                            const obj = new AV.Object('CourseInterpretation');
                            obj.set('name', d.name);
                            obj.set('content', d.content);
                            return obj;
                        });
                        try {
                            await AV.Object.saveAll(initInterps);
                            const interpQuery = new AV.Query('CourseInterpretation');
                            interpQuery.descending('createdAt');
                            const newResults = await interpQuery.limit(200).find();
                            setInterpretations(newResults.map(r => ({ ...r.attributes, id: r.id })));
                        } catch (e) {
                            console.error("Failed to initialize CourseInterpretation data:", e);
                        }
                    } else {
                        setInterpretations(interpResults.map(r => ({ ...r.attributes, id: r.id })));
                    }

                    setIsLoading(false);
                };
                initData();
            }, []);

            // --- ç°æœ‰åŠŸèƒ½ Handlers ---
            const handleTemplateSelect = (e) => {
                const courseId = e.target.value;
                if (!courseId) return; 
                const selectedCourse = courses.find(c => c.id === courseId);
                if (selectedCourse) {
                    setCurrentRecord(prev => ({
                        ...prev, courseId: selectedCourse.id, courseName: selectedCourse.name, age: selectedCourse.age,
                        r1: selectedCourse.r1, r2: selectedCourse.r2, r3: selectedCourse.r3, r4: selectedCourse.r4
                    }));
                }
            };
            
            const handleClassSelect = (e) => { if(e.target.value) setCurrentRecord(prev => ({...prev, className: e.target.value})); };
            const handleAIFillData = (data) => {
                setCurrentRecord(prev => ({ ...prev, r1: data.r1 || prev.r1, r2: data.r2 || prev.r2, r3: data.r3 || prev.r3, r4: data.r4 || prev.r4 }));
            };

            const handleSaveRecord = async () => {
                if (!currentRecord.courseName || !currentRecord.className) { alert("è¯·è‡³å°‘å¡«å†™ã€ç­çº§åç§°ã€‘å’Œã€è¯¾ç¨‹åç§°ã€‘ï¼"); return; }
                setIsLoading(true);
                try {
                    let record;
                    if (editingId) { record = AV.Object.createWithoutData('TeachingRecord', editingId); } 
                    else { const Record = AV.Object.extend('TeachingRecord'); record = new Record(); }
                    
                    record.set('date', currentRecord.date);
                    record.set('className', currentRecord.className);
                    record.set('courseName', currentRecord.courseName);
                    record.set('courseId', currentRecord.courseId);
                    record.set('age', currentRecord.age);
                    record.set('r1', currentRecord.r1 || ''); record.set('r2', currentRecord.r2 || '');
                    record.set('r3', currentRecord.r3 || ''); record.set('r4', currentRecord.r4 || '');
                    
                    const saved = await record.save();
                    if (editingId) { setRecords(records.map(r => r.id === editingId ? { ...saved.attributes, id: saved.id } : r)); alert("è®°å½•å·²æ›´æ–°ï¼"); } 
                    else { setRecords([{ ...saved.attributes, id: saved.id }, ...records]); alert("ä¿å­˜æˆåŠŸï¼"); }
                    setEditingId(null);
                    setCurrentRecord({ date: new Date().toISOString().split('T')[0], className: '', courseId: '', courseName: '', age: '', r1: '', r2: '', r3: '', r4: '' });
                } catch (error) { alert("ä¿å­˜å¤±è´¥: " + error.message); } finally { setIsLoading(false); }
            };
            
            const handleEditRecord = (record) => {
                setCurrentRecord({ ...record, courseId: record.courseId || '' });
                setEditingId(record.id); window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            const handleCancelEdit = () => { if (confirm("ç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿ")) { setEditingId(null); setCurrentRecord({ date: new Date().toISOString().split('T')[0], className: '', courseId: '', courseName: '', age: '', r1: '', r2: '', r3: '', r4: '' }); } };
            const handleDeleteRecord = async (id) => {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
                setIsLoading(true);
                try { const record = AV.Object.createWithoutData('TeachingRecord', id); await record.destroy(); setRecords(records.filter(r => r.id !== id)); } 
                catch (error) { alert("åˆ é™¤å¤±è´¥: " + error.message); } finally { setIsLoading(false); }
            };
            const handleAddClass = async () => {
                if(newClassInput && !savedClasses.find(c => c.name === newClassInput)) {
                    setIsLoading(true); try { const ClassObj = AV.Object.extend('ClassPreset'); const newClass = new ClassObj(); newClass.set('name', newClassInput); const saved = await newClass.save(); setSavedClasses([...savedClasses, { name: saved.get('name'), id: saved.id }]); setNewClassInput(''); } catch (error) { alert("å¤±è´¥: " + error.message); } finally { setIsLoading(false); }
                }
            };
            const handleDeleteClass = async (id) => { if(confirm(`ç¡®å®šåˆ é™¤å—ï¼Ÿ`)) { setIsLoading(true); try { const obj = AV.Object.createWithoutData('ClassPreset', id); await obj.destroy(); setSavedClasses(savedClasses.filter(c => c.id !== id)); } catch(e){ alert(e.message); } finally { setIsLoading(false); } } };
            const handleSaveAsCourse = async () => {
                if (!currentRecord.courseName) { alert("è¯·å…ˆè¾“å…¥è¯¾ç¨‹åç§°ï¼"); return; }
                setIsLoading(true);
                try { const Course = AV.Object.extend('CourseTemplate'); const course = new Course(); course.set('name', currentRecord.courseName); course.set('age', currentRecord.age || '8'); course.set('r1', currentRecord.r1); course.set('r2', currentRecord.r2); course.set('r3', currentRecord.r3); course.set('r4', currentRecord.r4); const saved = await course.save(); setCourses([...courses, { ...saved.attributes, id: saved.id }]); alert(`è¯¾ç¨‹åŒæ­¥æˆåŠŸï¼`); } catch (e) { alert("å¤±è´¥: " + e.message); } finally { setIsLoading(false); }
            };

            // --- è¯¾ç¨‹è§£è¯» Handlers (æ–°å¢è¡¨æ ¼å¯¼å…¥åŠŸèƒ½) ---
            const handleSaveInterpretation = async (name, content) => {
                setIsLoading(true);
                try {
                    const Interp = AV.Object.extend('CourseInterpretation');
                    const obj = new Interp();
                    obj.set('name', name);
                    obj.set('content', content);
                    const saved = await obj.save();
                    setInterpretations([{ ...saved.attributes, id: saved.id }, ...interpretations]);
                    setSelectedInterpId(saved.id);
                    alert("è¯¾ç¨‹è§£è¯»å·²å…¥åº“ï¼");
                } catch (e) { alert("å…¥åº“å¤±è´¥ï¼š" + e.message); } 
                finally { setIsLoading(false); }
            };

            const handleDeleteInterpretation = async (id, e) => {
                e.stopPropagation();
                if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡è§£è¯»å—ï¼Ÿ")) return;
                try { 
                    const obj = AV.Object.createWithoutData('CourseInterpretation', id); 
                    await obj.destroy(); 
                    setInterpretations(interpretations.filter(i => i.id !== id)); 
                    if(selectedInterpId === id) setSelectedInterpId(null);
                }
                catch(e) { alert("åˆ é™¤å¤±è´¥"); }
            };
            
            const handleCopyInterpretation = (content, e) => {
                if(e) e.stopPropagation();
                navigator.clipboard.writeText(content);
                alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
            };

            // å¤„ç† CSV/Excel æ–‡ä»¶å¯¼å…¥
            const handleImportClick = () => {
                fileInputRef.current.click();
            };

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setIsLoading(true);
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const data = evt.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 }); // æ•°ç»„æ•°ç»„æ ¼å¼

                        if (jsonData.length < 2) {
                            alert("è¡¨æ ¼å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®ï¼");
                            setIsLoading(false);
                            return;
                        }

                        // ç®€å•çš„åˆ—å—…æ¢ï¼šæŸ¥æ‰¾åŒ…å«"è¯¾ç¨‹"å’Œ"è§£è¯»"å­—æ ·çš„åˆ—ç´¢å¼•
                        const headerRow = jsonData[0].map(h => String(h).trim());
                        const nameIdx = headerRow.findIndex(h => h.includes('è¯¾ç¨‹') && !h.includes('è§£è¯»'));
                        const contentIdx = headerRow.findIndex(h => h.includes('è§£è¯»'));

                        if (nameIdx === -1 || contentIdx === -1) {
                            alert("æ— æ³•è¯†åˆ«è¡¨æ ¼åˆ—åï¼è¯·ç¡®ä¿è¡¨æ ¼ç¬¬ä¸€è¡ŒåŒ…å«â€œè¯¾ç¨‹â€å’Œâ€œè¯¾ç¨‹è§£è¯»â€å­—æ ·ã€‚");
                            setIsLoading(false);
                            return;
                        }

                        // æå–æ•°æ®
                        const newObjects = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const name = row[nameIdx];
                            const content = row[contentIdx];
                            if (name && content) {
                                const obj = new AV.Object('CourseInterpretation');
                                obj.set('name', String(name));
                                obj.set('content', String(content));
                                newObjects.push(obj);
                            }
                        }

                        if (newObjects.length > 0) {
                            await AV.Object.saveAll(newObjects);
                            // åˆ·æ–°åˆ—è¡¨
                            const interpQuery = new AV.Query('CourseInterpretation');
                            interpQuery.descending('createdAt');
                            const newResults = await interpQuery.limit(200).find();
                            setInterpretations(newResults.map(r => ({ ...r.attributes, id: r.id })));
                            alert(`æˆåŠŸå¯¼å…¥ ${newObjects.length} æ¡è¯¾ç¨‹è§£è¯»ï¼`);
                        } else {
                            alert("æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„è§£è¯»æ•°æ®ã€‚");
                        }
                    } catch (error) {
                        alert("å¯¼å…¥å¤±è´¥: " + error.message);
                    } finally {
                        setIsLoading(false);
                        e.target.value = ''; // é‡ç½® input
                    }
                };
                reader.readAsBinaryString(file);
            };

            // --- å¯¼å‡º Excel ---
            const handleExportExcel = () => {
                // ... (ä¿æŒåŸæœ‰å¯¼å‡ºé€»è¾‘)
                const titleRow = [settings.title]; 
                const fullHeaderRow = ["åºå·", "è¯¾ç¨‹åç§°", "æˆè¯¾æ—¶é—´", "æˆè¯¾ç­çº§", "å¹´é¾„æ®µ", "åæ€1:ç›®æ ‡", "åæ€2:æ€ç»´", "åæ€3:æµç¨‹", "åæ€4:ç¼–ç¨‹"];
                const sortedRecords = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
                const dataRows = sortedRecords.map((record, index) => [
                    index + 1, record.courseName, record.date, record.className, record.age,
                    record.r1, record.r2, record.r3, record.r4
                ]);
                const wsData = [titleRow, fullHeaderRow, ...dataRows];
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 8 } }];
                ws['!cols'] = [{ wch: 6 }, { wch: 20 }, { wch: 12 }, { wch: 15 }, { wch: 8 }, { wch: 30 }, { wch: 30 }, { wch: 30 }, { wch: 30 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "æ•™å­¦åæ€");
                XLSX.writeFile(wb, `æ•™å­¦åæ€_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const filteredInterpretations = interpretations.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()) || i.content.includes(searchTerm));
            const selectedInterpretation = interpretations.find(i => i.id === selectedInterpId);

            return (
                <div className="min-h-screen bg-gray-50 flex font-sans text-gray-800">
                    <AIModal isOpen={isAIModalOpen} onClose={() => setIsAIModalOpen(false)} onFillData={handleAIFillData} courseName={currentRecord.courseName} age={currentRecord.age} />
                    <InterpretationAIModal isOpen={isInterpAIModalOpen} onClose={() => setIsInterpAIModalOpen(false)} onFinish={handleSaveInterpretation} />
                    <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".csv,.xlsx,.xls" className="hidden" />
                    
                    {isLoading && <div className="loading-overlay"><span>å¤„ç†ä¸­...</span></div>}

                    {/* Sidebar */}
                    <div className="w-64 bg-slate-800 text-white flex flex-col p-4 shadow-xl shrink-0">
                        <h1 className="text-xl font-bold mb-8 flex items-center"><span className="mr-2"><IconCloud /></span> Veape Rethink<span className="text-xs bg-orange-500 ml-2 px-1 rounded">V6.4</span></h1>
                        <nav className="flex-1 space-y-2">
                            <button onClick={() => setActiveTab('record')} className={`w-full flex items-center p-3 rounded-lg transition ${activeTab === 'record' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-gray-300'}`}><span className="mr-3"><IconEdit3 /></span> æ•™å­¦åæ€å½•å…¥</button>
                            <button onClick={() => setActiveTab('interpretation')} className={`w-full flex items-center p-3 rounded-lg transition ${activeTab === 'interpretation' ? 'bg-orange-600 text-white' : 'hover:bg-slate-700 text-gray-300'}`}><span className="mr-3"><IconMessage /></span> è¯¾ç¨‹è§£è¯»åº“</button>
                            <button onClick={() => setActiveTab('library')} className={`w-full flex items-center p-3 rounded-lg transition ${activeTab === 'library' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-gray-300'}`}><span className="mr-3"><IconFileText /></span> è¯¾ç¨‹æ¨¡ç‰ˆç®¡ç†</button>
                            <button onClick={() => setActiveTab('settings')} className={`w-full flex items-center p-3 rounded-lg transition ${activeTab === 'settings' ? 'bg-blue-600 text-white' : 'hover:bg-slate-700 text-gray-300'}`}><span className="mr-3"><IconSettings /></span> ç³»ç»Ÿ/ç­çº§è®¾ç½®</button>
                        </nav>
                        <div className="mt-auto p-4 bg-slate-900 rounded text-sm text-gray-400">
                            <p>äº‘ç«¯åæ€: {records.length} æ¡</p>
                            <p>è¯¾ç¨‹è§£è¯»: {interpretations.length} æ¡</p>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 p-8 overflow-y-auto">
                        
                        {/* 1. æ•™å­¦åæ€ Tab (ä¿æŒä¸å˜) */}
                        {activeTab === 'record' && (
                            <div className="max-w-5xl mx-auto">
                                <header className="mb-6 flex justify-between items-end">
                                    <div><h2 className="text-2xl font-bold text-gray-800">å‘¨åº¦ä¸Šè¯¾è®°å½• & åæ€</h2><p className="text-gray-500 text-sm mt-1">æ”¯æŒ AI è‡ªåŠ¨ç”Ÿæˆåæ€ï¼Œå¡«å†™åå¯ä¸€é”®å¯¼å‡º Excel</p></div>
                                    <button onClick={handleExportExcel} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow flex items-center font-medium transition"><span className="mr-2"><IconDownload /></span> å¯¼å‡º Excel</button>
                                </header>
                                <div className={`bg-white rounded-xl shadow-sm border ${editingId ? 'border-yellow-400 ring-2 ring-yellow-100' : 'border-gray-200'} p-6 mb-8 relative transition-all duration-300`}>
                                    {editingId && (<div className="absolute -top-3 left-6 bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-full shadow flex items-center"><span>æ­£åœ¨ç¼–è¾‘æ¨¡å¼</span><button onClick={handleCancelEdit} className="ml-2 hover:bg-yellow-500 rounded-full p-0.5"><IconX /></button></div>)}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <div><label className="block text-sm font-medium text-gray-700 mb-1">ä¸Šè¯¾æ—¥æœŸ</label><input type="date" value={currentRecord.date} onChange={(e) => setCurrentRecord({...currentRecord, date: e.target.value})} className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"/></div>
                                        <div><label className="block text-sm font-medium text-gray-700 mb-1">ç­çº§åç§°</label><div className="flex"><input type="text" placeholder="å¦‚: Scratch16ç­" value={currentRecord.className} onChange={(e) => setCurrentRecord({...currentRecord, className: e.target.value})} className="w-full border border-gray-300 rounded-l-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"/><select onChange={handleClassSelect} className="w-10 border border-l-0 border-gray-300 rounded-r-md bg-gray-50 text-gray-600 focus:outline-none cursor-pointer" value=""><option value="" disabled>â–¼</option>{savedClasses.map(cls => (<option key={cls.id} value={cls.name}>{cls.name}</option>))}</select></div></div>
                                        <div><label className="block text-sm font-medium text-gray-700 mb-1">å¹´é¾„æ®µ</label><input type="text" placeholder="å¦‚: 8" value={currentRecord.age} onChange={(e) => setCurrentRecord({...currentRecord, age: e.target.value})} className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"/></div>
                                    </div>
                                    <div className="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100 relative">
                                        <label className="block text-sm font-bold text-blue-800 mb-2">è¯¾ç¨‹åç§°</label>
                                        <div className="flex gap-2 mb-2">
                                            <div className="flex-1 relative"><input type="text" placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°..." value={currentRecord.courseName} onChange={(e) => setCurrentRecord({...currentRecord, courseName: e.target.value})} className="w-full border border-gray-300 rounded-l-md p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none h-full"/></div>
                                            <div className="w-1/3"><select onChange={handleTemplateSelect} className="w-full border border-gray-300 rounded-r-md p-2.5 bg-white text-gray-700 h-full focus:outline-none" value={currentRecord.courseId || ""}><option value="">â–¼ é€‰æ¨¡ç‰ˆ...</option>{courses.map(c => (<option key={c.id} value={c.id}>{c.name}</option>))}</select></div>
                                        </div>
                                        <div className="flex justify-between items-center"><p className="text-xs text-blue-600 flex items-center"><span className="mr-1">ğŸ’¡</span> è¾“å…¥è¯¾ç¨‹å’Œç­çº§å³å¯ä¿å­˜ã€‚</p><button onClick={() => setIsAIModalOpen(true)} className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-sm px-4 py-1.5 rounded-full shadow hover:shadow-lg transition transform hover:scale-105 flex items-center font-bold"><IconMagic /> <span className="ml-1">AI åæ€ç”Ÿæˆ</span></button></div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {[{key:'r1',label:'åæ€1: æ•™å­¦ç›®æ ‡'},{key:'r2',label:'åæ€2: æ€ç»´èƒ½åŠ›'},{key:'r3',label:'åæ€3: è¯¾ç¨‹æµç¨‹'},{key:'r4',label:'åæ€4: ç¼–ç¨‹/æ­å»º'}].map((field) => (
                                            <div key={field.key} className="relative"><label className="block text-xs font-semibold text-gray-500 uppercase mb-1 tracking-wider">{field.label}</label><textarea value={currentRecord[field.key]} onChange={(e) => setCurrentRecord({...currentRecord, [field.key]: e.target.value})} className="w-full h-24 border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none transition-colors" placeholder="(é€‰å¡«) å¯åç»­ç¼–è¾‘è¡¥å……..."/></div>
                                        ))}
                                    </div>
                                    <div className="mt-6 flex justify-between items-center pt-4 border-t border-gray-100">
                                        <button onClick={handleSaveAsCourse} className="text-gray-500 hover:text-blue-600 text-sm flex items-center px-3 py-2 rounded hover:bg-gray-100 transition"><span className="mr-2"><IconSave /></span> åŒæ­¥åˆ°è¯¾ç¨‹æ¨¡ç‰ˆ</button>
                                        <div className="flex gap-3">
                                            {editingId && (<button onClick={handleCancelEdit} className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2.5 rounded-lg shadow-sm font-bold transition">å–æ¶ˆ</button>)}
                                            <button onClick={handleSaveRecord} className={`${editingId ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-600 hover:bg-blue-700'} text-white px-8 py-2.5 rounded-lg shadow-md flex items-center font-bold transition transform active:scale-95`}>{editingId ? <><span className="mr-2"><IconUpdate /></span> æ›´æ–°è®°å½•</> : <><span className="mr-2"><IconPlus /></span> ä¿å­˜åˆ°äº‘ç«¯</>}</button>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center"><h3 className="font-semibold text-gray-700">æœ€è¿‘è®°å½• (äº‘ç«¯: {records.length})</h3></div>
                                    <div className="divide-y divide-gray-100">
                                        {records.map((rec, idx) => (
                                            <div key={rec.id} className={`p-4 transition flex items-start group ${editingId === rec.id ? 'bg-yellow-50' : 'hover:bg-gray-50'}`}>
                                                <div className="w-10 pt-1 font-mono text-gray-400 text-sm">#{idx + 1}</div>
                                                <div className="flex-1 grid grid-cols-1 md:grid-cols-12 gap-4">
                                                    <div className="md:col-span-3"><p className="font-bold text-gray-800">{rec.courseName}</p><p className="text-xs text-gray-500">{rec.date} | {rec.className}</p></div>
                                                    <div className="md:col-span-8 text-sm text-gray-600 space-y-1">{!rec.r1 && !rec.r4 ? (<span className="text-gray-400 italic">ï¼ˆåæ€å†…å®¹å¾…è¡¥å……...ï¼‰</span>) : (<><p className="line-clamp-1"><span className="text-blue-600 font-medium">ç›®æ ‡:</span> {rec.r1 || '-'}</p><p className="line-clamp-1"><span className="text-purple-600 font-medium">ç¼–ç¨‹:</span> {rec.r4 || '-'}</p></>)}</div>
                                                    <div className="md:col-span-1 flex justify-end items-center gap-2 opacity-0 group-hover:opacity-100 transition"><button onClick={() => handleEditRecord(rec)} className="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50" title="ç¼–è¾‘"><IconEdit3 /></button><button onClick={() => handleDeleteRecord(rec.id)} className="text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50" title="åˆ é™¤"><IconTrash2 /></button></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 2. è¯¾ç¨‹è§£è¯» Tab (å¢å¼ºç‰ˆ) */}
                        {activeTab === 'interpretation' && (
                            <div className="max-w-6xl mx-auto h-[calc(100vh-6rem)] flex flex-col">
                                <header className="mb-6 flex justify-between items-center">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-800 flex items-center"><IconMessage /> <span className="ml-2">è¯¾ç¨‹è§£è¯»åº“ (è¡¨3å†…å®¹)</span></h2>
                                        <p className="text-gray-500 text-sm mt-1">åŒ…å«æ˜Ÿé™…è¿·èˆªã€å•ç‰‡æœºç­‰å†…ç½®è§£è¯»ï¼Œæ”¯æŒæ‰¹é‡å¯¼å…¥è¡¨æ ¼</p>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={handleImportClick} className="bg-white hover:bg-gray-50 border border-gray-300 text-gray-700 px-4 py-2 rounded-lg shadow-sm flex items-center font-bold transition">
                                            <IconUpload /> <span className="ml-2">å¯¼å…¥è¡¨æ ¼</span>
                                        </button>
                                        <button onClick={() => setIsInterpAIModalOpen(true)} className="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg shadow-lg flex items-center font-bold transition transform hover:scale-105">
                                            <IconMagic /> <span className="ml-2">AI ç”Ÿæˆæ–°è§£è¯»</span>
                                        </button>
                                    </div>
                                </header>

                                <div className="flex-1 flex gap-6 overflow-hidden">
                                    {/* å·¦ä¾§ï¼šåˆ—è¡¨ */}
                                    <div className="w-1/3 flex flex-col bg-white rounded-xl shadow-sm border border-gray-200">
                                        <div className="p-4 border-b border-gray-200">
                                            <div className="relative">
                                                <input type="text" placeholder="æœç´¢è¯¾ç¨‹åç§°..." className="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm" value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)} />
                                                <div className="absolute left-3 top-2.5 text-gray-400"><IconSearch /></div>
                                            </div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                            {filteredInterpretations.length === 0 ? (
                                                <div className="text-center text-gray-400 py-10 text-sm">æš‚æ— è§£è¯»ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ç”Ÿæˆ</div>
                                            ) : (
                                                filteredInterpretations.map(item => (
                                                    <div 
                                                        key={item.id} 
                                                        onClick={() => setSelectedInterpId(item.id)}
                                                        className={`p-3 rounded-lg border cursor-pointer group transition relative shadow-sm ${selectedInterpId === item.id ? 'bg-orange-50 border-orange-200 ring-1 ring-orange-200' : 'bg-white border-gray-100 hover:bg-gray-50'}`}
                                                    >
                                                        <h4 className={`font-bold text-sm ${selectedInterpId === item.id ? 'text-orange-800' : 'text-gray-800'}`}>{item.name}</h4>
                                                        <p className="text-xs text-gray-500 mt-1 line-clamp-2">{item.content.substring(0, 50)}...</p>
                                                        <div className="mt-2 flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition">
                                                            <button onClick={(e) => handleDeleteInterpretation(item.id, e)} className="text-xs text-red-500 hover:bg-red-50 px-2 py-1 rounded">åˆ é™¤</button>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>

                                    {/* å³ä¾§ï¼šé¢„è§ˆåŒº */}
                                    <div className="flex-1 bg-white rounded-xl shadow-sm border border-gray-200 p-0 overflow-hidden flex flex-col">
                                        {selectedInterpretation ? (
                                            <>
                                                <div className="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                                    <h3 className="font-bold text-gray-700">å†…å®¹é¢„è§ˆ</h3>
                                                    <button onClick={() => handleCopyInterpretation(selectedInterpretation.content)} className="text-sm bg-white border border-gray-300 text-gray-700 px-3 py-1 rounded shadow-sm hover:bg-gray-50 flex items-center">
                                                        <IconCopy /> <span className="ml-1">ä¸€é”®å¤åˆ¶</span>
                                                    </button>
                                                </div>
                                                <div className="flex-1 p-8 overflow-y-auto bg-[url('https://www.transparenttextures.com/patterns/graphy.png')]">
                                                    <div className="max-w-3xl mx-auto bg-white p-8 shadow-sm border border-gray-100 rounded min-h-full">
                                                        <pre className="font-sans text-gray-700 whitespace-pre-wrap leading-relaxed">{selectedInterpretation.content}</pre>
                                                    </div>
                                                </div>
                                            </>
                                        ) : (
                                            <div className="flex-1 flex flex-col items-center justify-center text-gray-400 p-8">
                                                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4"><IconMessage /></div>
                                                <p>è¯·åœ¨å·¦ä¾§é€‰æ‹©è¯¾ç¨‹ï¼ŒæŸ¥çœ‹è§£è¯»è¯¦æƒ…</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 3. è¯¾ç¨‹æ¨¡ç‰ˆåº“ Tab (ä¿æŒä¸å˜) */}
                        {activeTab === 'library' && (
                            <div className="max-w-4xl mx-auto">
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">äº‘ç«¯è¯¾ç¨‹æ¨¡ç‰ˆåº“ (åæ€ä¸“ç”¨)</h2>
                                <div className="grid gap-6">
                                    {courses.map(c => (
                                        <div key={c.id} className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                            <div className="flex justify-between items-start mb-4">
                                                <div><h3 className="text-lg font-bold text-gray-900">{c.name}</h3><span className="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded mt-1">é€‚åˆå¹´é¾„: {c.age}å²</span></div>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                                                <div className="bg-gray-50 p-3 rounded"><span className="font-bold block text-gray-800 mb-1">ç›®æ ‡:</span> {c.r1}</div>
                                                <div className="bg-gray-50 p-3 rounded"><span className="font-bold block text-gray-800 mb-1">æ€ç»´:</span> {c.r2}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 4. è®¾ç½® Tab (ä¿æŒä¸å˜) */}
                        {activeTab === 'settings' && (
                            <div className="max-w-2xl mx-auto">
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">ç³»ç»Ÿ/ç­çº§è®¾ç½®</h2>
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center"><IconEdit3 /> <span className="ml-2">å¯¼å‡ºæ ‡é¢˜è®¾ç½®</span></h3>
                                        <div><label className="block text-sm font-medium text-gray-700 mb-1">è¡¨æ ¼æ ‡é¢˜ (Excelç¬¬ä¸€è¡Œ)</label><input type="text" value={settings.title} onChange={(e) => setSettings({...settings, title: e.target.value})} className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500"/></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center"><IconUser /> <span className="ml-2">äº‘ç«¯é¢„è®¾ç­çº§ç®¡ç†</span></h3>
                                        <div className="mb-4 flex gap-2"><input type="text" placeholder="è¾“å…¥æ–°ç­çº§åç§°" value={newClassInput} onChange={(e) => setNewClassInput(e.target.value)} className="flex-1 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500"/><button onClick={handleAddClass} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium">æ·»åŠ </button></div>
                                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-100"><div className="flex flex-wrap gap-2">{savedClasses.map(cls => (<span key={cls.id} className="bg-white border border-gray-300 rounded-full px-3 py-1 text-sm flex items-center group">{cls.name}<button onClick={() => handleDeleteClass(cls.id)} className="ml-2 text-gray-400 hover:text-red-500">&times;</button></span>))}</div></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>